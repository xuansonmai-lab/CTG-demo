<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTG Analysis - Ph√¢n t√≠ch tim thai</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-section {
            margin-bottom: 25px;
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        input[type="text"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .image-upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .image-upload-box {
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: white;
            transition: all 0.3s;
        }

        .image-upload-box:hover {
            border-color: #667eea;
            background: #f7f9ff;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: transform 0.3s;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .camera-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .uploaded-image {
            max-width: 100%;
            max-height: 300px;
            margin-top: 10px;
            border-radius: 8px;
            cursor: zoom-in;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .conditional-question {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #fff5f5;
            border-left: 3px solid #fc8181;
            border-radius: 5px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .export-btn {
            background: linear-gradient(135deg, #f56565 0%, #ed8936 100%);
            color: white;
        }

        .save-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .reset-btn {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .results-section {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .result-card {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .result-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .result-content {
            color: #4a5568;
            line-height: 1.6;
        }

        .status-normal {
            background: #c6f6d5;
            color: #22543d;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .status-suspicious {
            background: #fed7d7;
            color: #742a2a;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .status-abnormal {
            background: #feb2b2;
            color: #742a2a;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            margin: 2% auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #bbb;
        }

        @media (max-width: 768px) {
            .image-upload-section {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• CTG Analysis System</h1>
        
        <div class="form-section">
            <div class="form-group">
                <label for="patientId">ID B·ªánh nh√¢n (t√πy ch·ªçn):</label>
                <input type="text" id="patientId" placeholder="Nh·∫≠p ID b·ªánh nh√¢n...">
            </div>
        </div>

        <div class="form-section">
            <label>Upload ·∫£nh CTG (t√πy ch·ªçn):</label>
            <div class="image-upload-section">
                <div class="image-upload-box">
                    <h3>CTG tr∆∞·ªõc ƒë√≥</h3>
                    <input type="file" id="prevImage" accept="image/*" style="display: none;">
                    <button class="upload-btn" onclick="document.getElementById('prevImage').click()">üìÅ Ch·ªçn ·∫£nh</button>
                    <button class="upload-btn camera-btn" onclick="captureImage('prev')">üì∑ Ch·ª•p ·∫£nh</button>
                    <img id="prevImagePreview" class="uploaded-image" style="display: none;" onclick="openModal(this.src)">
                </div>
                
                <div class="image-upload-box">
                    <h3>CTG hi·ªán t·∫°i</h3>
                    <input type="file" id="currentImage" accept="image/*" style="display: none;">
                    <button class="upload-btn" onclick="document.getElementById('currentImage').click()">üìÅ Ch·ªçn ·∫£nh</button>
                    <button class="upload-btn camera-btn" onclick="captureImage('current')">üì∑ Ch·ª•p ·∫£nh</button>
                    <img id="currentImagePreview" class="uploaded-image" style="display: none;" onclick="openModal(this.src)">
                </div>
            </div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label for="uterineContractions">G√≤ t·ª≠ cung:</label>
                <select id="uterineContractions">
                    <option value="">-- Ch·ªçn --</option>
                    <option value="normal">< 5 c∆°n/10 ph√∫t</option>
                    <option value="frequent">‚â• 5 c∆°n/10 ph√∫t</option>
                    <option value="prolonged">C∆°n co k√©o d√†i ‚â• 2 ph√∫t</option>
                </select>
            </div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label for="baselineHR">Tim thai cƒÉn b·∫£n:</label>
                <select id="baselineHR" onchange="showBaselineOptions()">
                    <option value="">-- Ch·ªçn --</option>
                    <option value="<80">< 80 bpm</option>
                    <option value="80-100">80-100 bpm</option>
                    <option value="100-109">100-109 bpm</option>
                    <option value="110-160">110-160 bpm</option>
                    <option value="160-179">160-179 bpm</option>
                    <option value=">180">> 180 bpm</option>
                    <option value="undetectable">Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c baseline</option>
                </select>
                
                <div id="baseline100109Options" class="conditional-question">
                    <label>Tim thai 100-109 bpm n√†y:</label>
                    <select id="baseline100109Type">
                        <option value="">-- Ch·ªçn --</option>
                        <option value="new">M·ªõi xu·∫•t hi·ªán (tr∆∞·ªõc ƒë√≥ > 109 bpm)</option>
                        <option value="existing">ƒê√£ c√≥ t·ª´ tr∆∞·ªõc (bƒÉng ghi tr∆∞·ªõc c≈©ng 100-109 bpm)</option>
                    </select>
                </div>
                
                <div id="baseline110160Options" class="conditional-question">
                    <label>Tim thai cƒÉn b·∫£n c√≥ ·ªïn ƒë·ªãnh kh√¥ng?</label>
                    <select id="baselineStability" onchange="showStabilityDetails()">
                        <option value="">-- Ch·ªçn --</option>
                        <option value="stable">·ªîn ƒë·ªãnh</option>
                        <option value="unstable">Kh√¥ng ·ªïn ƒë·ªãnh</option>
                    </select>
                    
                    <div id="stableOptions" style="display: none; margin-top: 10px;">
                        <label>C√≥ cao h∆°n so v·ªõi ng∆∞·ª°ng b√¨nh th∆∞·ªùng c·ªßa tu·ªïi thai kh√¥ng?</label>
                        <select id="higherThanNormal">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="no">Kh√¥ng</option>
                            <option value="yes">C√≥ (tƒÉng > 10% so v·ªõi tr∆∞·ªõc)</option>
                        </select>
                    </div>
                    
                    <div id="unstableOptions" style="display: none; margin-top: 10px;">
                        <label>Ki·ªÉu kh√¥ng ·ªïn ƒë·ªãnh:</label>
                        <select id="unstableType">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="increase10">TƒÉng > 10% so v·ªõi tr∆∞·ªõc</option>
                            <option value="increase20">TƒÉng ‚â• 20 bpm so v·ªõi ƒë·∫ßu chuy·ªÉn d·∫°</option>
                            <option value="decreasing">ƒêang gi·∫£m d·∫ßn</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label for="variability">Dao ƒë·ªông n·ªôi t·∫°i:</label>
                <select id="variability" onchange="showVariabilityOptions()">
                    <option value="">-- Ch·ªçn --</option>
                    <option value="<3">Kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c (< 3 bpm)</option>
                    <option value="3-5">T·ªëi thi·ªÉu (3-5 bpm)</option>
                    <option value="6-25">Trung b√¨nh (6-25 bpm)</option>
                    <option value=">25">TƒÉng (> 25 bpm)</option>
                    <option value="sinusoidal">D·∫°ng h√¨nh sin</option>
                </select>
                
                <div id="variabilityLowOptions" class="conditional-question">
                    <label>Th·ªùi gian dao ƒë·ªông < 5 bpm:</label>
                    <select id="variabilityLowDuration">
                        <option value="">-- Ch·ªçn --</option>
                        <option value="30-50">30-50 ph√∫t</option>
                        <option value=">50">> 50 ph√∫t</option>
                        <option value=">90">> 90 ph√∫t</option>
                    </select>
                </div>
                
                <div id="variabilityHighOptions" class="conditional-question">
                    <label>Th·ªùi gian dao ƒë·ªông > 25 bpm:</label>
                    <select id="variabilityHighDuration">
                        <option value="">-- Ch·ªçn --</option>
                        <option value="‚â§10">‚â§ 10 ph√∫t</option>
                        <option value=">10">> 10 ph√∫t</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label for="decelerations">Nh·ªãp gi·∫£m:</label>
                <select id="decelerations" onchange="showDecelerationOptions()">
                    <option value="">-- Ch·ªçn --</option>
                    <option value="none">Kh√¥ng c√≥</option>
                    <option value="early">Nh·ªãp gi·∫£m s·ªõm</option>
                    <option value="variable">Nh·ªãp gi·∫£m b·∫•t ƒë·ªãnh</option>
                    <option value="late">Nh·ªãp gi·∫£m mu·ªôn</option>
                    <option value="prolonged">Nh·ªãp gi·∫£m k√©o d√†i</option>
                </select>
                
                <div id="decelerationDetails" class="conditional-question">
                    <label>Chi ti·∫øt nh·ªãp gi·∫£m:</label>
                    <div id="variableOptions" style="display: none;">
                        <select id="variableSeverity">
                            <option value="">-- M·ª©c ƒë·ªô --</option>
                            <option value="mild">Nh·∫π</option>
                            <option value="severe">N·∫∑ng (Nadir < 70 bpm v√† > 30s ho·∫∑c 70-80 bpm v√† > 60s)</option>
                        </select>
                        <select id="variableRepetition" style="margin-top: 10px;">
                            <option value="">-- T·∫ßn su·∫•t --</option>
                            <option value="single">ƒê∆°n l·∫ª</option>
                            <option value="repetitive">L·∫∑p l·∫°i</option>
                        </select>
                        <select id="variableFeatures" style="margin-top: 10px;">
                            <option value="">-- ƒê·∫∑c ƒëi·ªÉm --</option>
                            <option value="normal">Kh√¥ng c√≥ ƒë·∫∑c ƒëi·ªÉm ƒë√°ng ng·∫°i</option>
                            <option value="concerning">C√≥ ƒë·∫∑c ƒëi·ªÉm ƒë√°ng ng·∫°i (> 60s, gi·∫£m dao ƒë·ªông, ph·ª•c h·ªìi ch·∫≠m, m·∫•t vai)</option>
                        </select>
                        <select id="variableDuration" style="margin-top: 10px;">
                            <option value="">-- Th·ªùi gian xu·∫•t hi·ªán --</option>
                            <option value="<30">< 30 ph√∫t</option>
                            <option value="‚â•30">‚â• 30 ph√∫t</option>
                        </select>
                    </div>
                    
                    <div id="lateOptions" style="display: none;">
                        <select id="lateSeverity">
                            <option value="">-- M·ª©c ƒë·ªô --</option>
                            <option value="mild">Nh·∫π</option>
                            <option value="severe">N·∫∑ng (gi·∫£m > 15 bpm)</option>
                        </select>
                        <select id="lateRepetition" style="margin-top: 10px;">
                            <option value="">-- T·∫ßn su·∫•t --</option>
                            <option value="single">ƒê∆°n l·∫ª</option>
                            <option value="repetitive">L·∫∑p l·∫°i</option>
                        </select>
                        <select id="lateDuration" style="margin-top: 10px;">
                            <option value="">-- Th·ªùi gian xu·∫•t hi·ªán --</option>
                            <option value="<20">< 20 ph√∫t</option>
                            <option value="20-30">20-30 ph√∫t</option>
                            <option value=">30">> 30 ph√∫t</option>
                        </select>
                    </div>
                    
                    <div id="prolongedOptions" style="display: none;">
                        <select id="prolongedDuration">
                            <option value="">-- Th·ªùi gian k√©o d√†i --</option>
                            <option value="2-3">2-3 ph√∫t</option>
                            <option value=">3">> 3 ph√∫t</option>
                            <option value=">5">> 5 ph√∫t</option>
                            <option value=">10">> 10 ph√∫t</option>
                        </select>
                        <select id="prolongedNadir" style="margin-top: 10px;">
                            <option value="">-- ƒêi·ªÉm th·∫•p nh·∫•t --</option>
                            <option value=">80">> 80 bpm</option>
                            <option value="<80">< 80 bpm</option>
                        </select>
                        <select id="prolongedRepetition" style="margin-top: 10px;">
                            <option value="">-- T·∫ßn su·∫•t --</option>
                            <option value="single">ƒê∆°n l·∫ª</option>
                            <option value="repetitive">L·∫∑p l·∫°i</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label for="accelerations">Nh·ªãp tƒÉng:</label>
                <select id="accelerations">
                    <option value="">-- Ch·ªçn --</option>
                    <option value="present">C√≥</option>
                    <option value="absent">Kh√¥ng c√≥</option>
                    <option value="atypical">Kh√¥ng ƒëi·ªÉn h√¨nh</option>
                </select>
            </div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label for="overallDescription">M√¥ t·∫£ t·ªïng qu√°t bƒÉng ghi CTG:</label>
                <textarea id="overallDescription" rows="4" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn analyze-btn" onclick="analyzeResults()">
                üîç Ph√¢n t√≠ch k·∫øt qu·∫£
            </button>
            <button class="action-btn export-btn" onclick="exportPDF()">
                üìÑ Xu·∫•t b√°o c√°o PDF
            </button>
            <button class="action-btn save-btn" onclick="saveToGoogleSheets()">
                üíæ L∆∞u d·ªØ li·ªáu
            </button>
            <button class="action-btn reset-btn" onclick="resetForm()">
                üîÑ ƒê√°nh gi√° ti·∫øp
            </button>
        </div>

        <div class="loading">
            <div class="spinner"></div>
            <p>ƒêang ph√¢n t√≠ch...</p>
        </div>

        <div class="results-section" id="resultsSection">
            <h2 style="text-align: center; margin-bottom: 20px; color: #2d3748;">üìä K·∫øt qu·∫£ ph√¢n t√≠ch CTG</h2>
            
            <div class="result-card">
                <div class="result-title">Ph√¢n lo·∫°i theo NICE 2022</div>
                <div class="result-content" id="niceResult"></div>
            </div>
            
            <div class="result-card">
                <div class="result-title">Ph√¢n lo·∫°i theo RCOG 2001</div>
                <div class="result-content" id="rcogResult"></div>
            </div>
            
            <div class="result-card">
                <div class="result-title">Ph√¢n lo·∫°i theo FIGO 2015</div>
                <div class="result-content" id="figoResult"></div>
            </div>
            
            <div class="result-card">
                <div class="result-title">Ph√¢n lo·∫°i theo ACOG 2009</div>
                <div class="result-content" id="acogResult"></div>
            </div>
            
            <div class="result-card">
                <div class="result-title">Ph√¢n lo·∫°i sinh l√Ω/b·ªánh l√Ω 2024</div>
                <div class="result-content" id="physioResult"></div>
            </div>
            
            <div class="result-card">
                <div class="result-title">Khuy·∫øn c√°o x·ª≠ tr√≠</div>
                <div class="result-content" id="recommendationResult"></div>
            </div>
        </div>
    </div>

    <div id="imageModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script>
        // Image handling
        document.getElementById('prevImage').addEventListener('change', function(e) {
            handleImageUpload(e, 'prevImagePreview');
        });

        document.getElementById('currentImage').addEventListener('change', function(e) {
            handleImageUpload(e, 'currentImagePreview');
        });

        function handleImageUpload(e, previewId) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById(previewId);
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function captureImage(type) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewId = type === 'prev' ? 'prevImagePreview' : 'currentImagePreview';
                        const preview = document.getElementById(previewId);
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            input.click();
        }

        function openModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'block';
            modalImg.src = src;
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // Conditional questions handling
        function showBaselineOptions() {
            const baseline = document.getElementById('baselineHR').value;
            const options100109 = document.getElementById('baseline100109Options');
            const options110160 = document.getElementById('baseline110160Options');
            
            options100109.style.display = 'none';
            options110160.style.display = 'none';
            
            if (baseline === '100-109') {
                options100109.style.display = 'block';
            } else if (baseline === '110-160') {
                options110160.style.display = 'block';
            }
        }

        function showStabilityDetails() {
            const stability = document.getElementById('baselineStability').value;
            const stableOptions = document.getElementById('stableOptions');
            const unstableOptions = document.getElementById('unstableOptions');
            
            stableOptions.style.display = 'none';
            unstableOptions.style.display = 'none';
            
            if (stability === 'stable') {
                stableOptions.style.display = 'block';
            } else if (stability === 'unstable') {
                unstableOptions.style.display = 'block';
            }
        }

        function showVariabilityOptions() {
            const variability = document.getElementById('variability').value;
            const lowOptions = document.getElementById('variabilityLowOptions');
            const highOptions = document.getElementById('variabilityHighOptions');
            
            lowOptions.style.display = 'none';
            highOptions.style.display = 'none';
            
            if (variability === '<3' || variability === '3-5') {
                lowOptions.style.display = 'block';
            } else if (variability === '>25') {
                highOptions.style.display = 'block';
            }
        }

        function showDecelerationOptions() {
            const deceleration = document.getElementById('decelerations').value;
            const details = document.getElementById('decelerationDetails');
            const variableOpts = document.getElementById('variableOptions');
            const lateOpts = document.getElementById('lateOptions');
            const prolongedOpts = document.getElementById('prolongedOptions');
            
            details.style.display = 'none';
            variableOpts.style.display = 'none';
            lateOpts.style.display = 'none';
            prolongedOpts.style.display = 'none';
            
            if (deceleration === 'variable') {
                details.style.display = 'block';
                variableOpts.style.display = 'block';
            } else if (deceleration === 'late') {
                details.style.display = 'block';
                lateOpts.style.display = 'block';
            } else if (deceleration === 'prolonged') {
                details.style.display = 'block';
                prolongedOpts.style.display = 'block';
            }
        }

        // Analysis functions
        function analyzeResults() {
            document.querySelector('.loading').style.display = 'block';
            
            setTimeout(() => {
                const data = collectFormData();
                const niceClass = classifyNICE(data);
                const rcogClass = classifyRCOG(data);
                const figoClass = classifyFIGO(data);
                const acogClass = classifyACOG(data);
                const physioClass = classifyPhysiology(data);
                
                displayResults(niceClass, rcogClass, figoClass, acogClass, physioClass);
                
                document.querySelector('.loading').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';
                
                // Scroll to results
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            }, 1000);
        }

        function collectFormData() {
            return {
                patientId: document.getElementById('patientId').value,
                uterineContractions: document.getElementById('uterineContractions').value,
                baselineHR: document.getElementById('baselineHR').value,
                baseline100109Type: document.getElementById('baseline100109Type').value,
                baselineStability: document.getElementById('baselineStability').value,
                higherThanNormal: document.getElementById('higherThanNormal').value,
                unstableType: document.getElementById('unstableType').value,
                variability: document.getElementById('variability').value,
                variabilityLowDuration: document.getElementById('variabilityLowDuration').value,
                variabilityHighDuration: document.getElementById('variabilityHighDuration').value,
                decelerations: document.getElementById('decelerations').value,
                variableSeverity: document.getElementById('variableSeverity').value,
                variableRepetition: document.getElementById('variableRepetition').value,
                variableFeatures: document.getElementById('variableFeatures').value,
                variableDuration: document.getElementById('variableDuration').value,
                lateSeverity: document.getElementById('lateSeverity').value,
                lateRepetition: document.getElementById('lateRepetition').value,
                lateDuration: document.getElementById('lateDuration').value,
                prolongedDuration: document.getElementById('prolongedDuration').value,
                prolongedNadir: document.getElementById('prolongedNadir').value,
                prolongedRepetition: document.getElementById('prolongedRepetition').value,
                accelerations: document.getElementById('accelerations').value,
                overallDescription: document.getElementById('overallDescription').value
            };
        }

        function classifyNICE(data) {
            let suspicious = 0;
            let abnormal = 0;
            
            // Uterine contractions
            if (data.uterineContractions === 'frequent' || data.uterineContractions === 'prolonged') {
                suspicious++;
            }
            
            // Baseline HR
            if (data.baselineHR === '100-109' || data.baselineHR === 'undetectable') {
                suspicious++;
            } else if (data.baselineHR === '<80' || data.baselineHR === '80-100' || data.baselineHR === '>180') {
                abnormal++;
            } else if (data.baselineHR === '110-160') {
                if (data.unstableType === 'increase20') {
                    suspicious++;
                }
            }
            
            // Variability
            if (data.variability === '3-5' && data.variabilityLowDuration === '30-50') {
                suspicious++;
            } else if (data.variability === '<3' && data.variabilityLowDuration === '>50') {
                abnormal++;
            } else if (data.variability === '>25' && data.variabilityHighDuration === '>10') {
                abnormal++;
            } else if (data.variability === 'sinusoidal') {
                abnormal++;
            }
            
            // Decelerations
            if (data.decelerations === 'variable') {
                if (data.variableFeatures === 'concerning' && data.variableDuration === '‚â•30') {
                    abnormal++;
                } else if (data.variableFeatures === 'concerning' && data.variableDuration === '<30') {
                    suspicious++;
                }
            } else if (data.decelerations === 'late') {
                if (data.lateSeverity === 'severe' && data.lateRepetition === 'repetitive' && data.lateDuration === '>30') {
                    abnormal++;
                } else if (data.lateSeverity === 'severe' && data.lateRepetition === 'repetitive' && data.lateDuration !== '>30') {
                    suspicious++;
                }
            } else if (data.decelerations === 'prolonged') {
                if (data.prolongedDuration === '>3') {
                    abnormal++;
                }
            }
            
            if (abnormal > 0 || suspicious >= 2) {
                return { category: 'B·∫•t th∆∞·ªùng', color: 'red' };
            } else if (suspicious === 1) {
                return { category: 'Nghi ng·ªù', color: 'yellow' };
            } else {
                return { category: 'B√¨nh th∆∞·ªùng', color: 'green' };
            }
        }

        function classifyRCOG(data) {
            let suspicious = 0;
            let abnormal = 0;
            
            // Baseline
            if (data.baselineHR === '100-109' || data.baselineHR === '160-179') {
                suspicious++;
            } else if (data.baselineHR === '<80' || data.baselineHR === '80-100' || data.baselineHR === '>180') {
                abnormal++;
            }
            
            // Variability
            if (data.variability === '3-5' || data.variability === '<3') {
                if (data.variabilityLowDuration === '>90') {
                    abnormal++;
                } else {
                    suspicious++;
                }
            } else if (data.variability === 'sinusoidal') {
                abnormal++;
            }
            
            // Decelerations
            if (data.decelerations === 'early' || (data.decelerations === 'variable' && data.variableFeatures === 'normal')) {
                suspicious++;
            } else if (data.decelerations === 'variable' && data.variableFeatures === 'concerning') {
                abnormal++;
            } else if (data.decelerations === 'late' && data.lateSeverity === 'severe') {
                abnormal++;
            } else if (data.decelerations === 'prolonged' && data.prolongedDuration === '>3') {
                abnormal++;
            }
            
            // Accelerations
            if (data.accelerations === 'absent') {
                suspicious++;
            }
            
            if (abnormal >= 1 || suspicious >= 2) {
                return { category: 'B·∫•t th∆∞·ªùng', color: 'red' };
            } else if (suspicious === 1) {
                return { category: 'Nghi ng·ªù', color: 'yellow' };
            } else {
                return { category: 'B√¨nh th∆∞·ªùng', color: 'green' };
            }
        }

        function classifyFIGO(data) {
            let suspicious = 0;
            let pathological = 0;
            
            // Baseline
            if (data.baselineHR === '100-109' || data.baselineHR === '160-179' || data.baselineHR === '>180') {
                suspicious++;
            } else if (data.baselineHR === '<80' || data.baselineHR === '80-100') {
                pathological++;
            }
            
            // Variability
            if (data.variability === '<3' || data.variability === '>25' || data.variability === 'sinusoidal') {
                pathological++;
            }
            
            // Decelerations
            if (data.decelerations === 'late' && data.lateSeverity === 'severe' && data.lateRepetition === 'repetitive' && data.lateDuration === '>30') {
                pathological++;
            } else if (data.decelerations === 'prolonged' && data.prolongedDuration === '>3' && data.prolongedRepetition === 'repetitive') {
                pathological++;
            } else if (data.decelerations === 'variable' || data.decelerations === 'late' || data.decelerations === 'prolonged') {
                suspicious++;
            }
            
            if (pathological >= 1) {
                return { category: 'B·ªánh l√Ω', color: 'red' };
            } else if (suspicious >= 1) {
                return { category: 'Nghi ng·ªù', color: 'yellow' };
            } else {
                return { category: 'B√¨nh th∆∞·ªùng', color: 'green' };
            }
        }

        function classifyACOG(data) {
            // Category I criteria
            const isCategoryI = 
                (data.baselineHR === '110-160') &&
                (data.variability === '6-25') &&
                (data.decelerations === 'none' || data.decelerations === 'early') &&
                (data.lateSeverity !== 'severe' && data.lateRepetition !== 'repetitive');
            
            // Category III criteria
            const isCategoryIII = 
                (data.variability === '<3' && (
                    (data.decelerations === 'late' && data.lateSeverity === 'severe' && data.lateRepetition === 'repetitive') ||
                    (data.decelerations === 'variable' && data.variableRepetition === 'repetitive') ||
                    (data.baselineHR === '<80' || data.baselineHR === '80-100')
                )) ||
                (data.variability === 'sinusoidal');
            
            if (isCategoryI) {
                return { category: 'Nh√≥m I', color: 'green' };
            } else if (isCategoryIII) {
                return { category: 'Nh√≥m III', color: 'red' };
            } else {
                return { category: 'Nh√≥m II', color: 'yellow' };
            }
        }

        function classifyPhysiology(data) {
            // Non-hypoxic
            const isNonHypoxic = 
                (data.baselineHR === '110-160') &&
                (data.baselineStability === 'stable') &&
                (data.variability === '6-25') &&
                (data.decelerations === 'none' || (data.decelerations === 'early' && data.variableRepetition !== 'repetitive'));
            
            // Progressive hypoxia - compensated
            const isCompensated = 
                (data.baselineHR === '160-179' || data.baselineHR === '>180' || 
                 data.unstableType === 'increase10' || data.higherThanNormal === 'yes') &&
                (data.variability === '6-25');
            
            // Progressive hypoxia - decompensated
            const isDecompensated = 
                (data.variability === '<3' || data.variability === '3-5' || data.variability === '>25') &&
                ((data.baselineHR === '160-179' || data.baselineHR === '>180') ||
                 (data.decelerations === 'variable' && data.variableRepetition === 'repetitive') ||
                 (data.decelerations === 'late' && data.lateRepetition === 'repetitive') ||
                 (data.unstableType === 'decreasing'));
            
            // Subacute hypoxia
            const isSubacute = 
                data.decelerations === 'variable' && data.variableRepetition === 'repetitive' &&
                data.variableDuration === '‚â•30';
            
            // Acute hypoxia
            const isAcute = 
                data.decelerations === 'prolonged' && data.prolongedDuration === '>3';
            
            if (isAcute) {
                return { category: 'Thi·∫øu oxy c·∫•p', color: 'red' };
            } else if (isSubacute) {
                return { category: 'Thi·∫øu oxy b√°n c·∫•p', color: 'red' };
            } else if (isDecompensated) {
                return { category: 'Thi·∫øu oxy di·ªÖn ti·∫øn m·∫•t b√π', color: 'orange' };
            } else if (isCompensated) {
                return { category: 'Thi·∫øu oxy di·ªÖn ti·∫øn c√≤n b√π', color: 'yellow' };
            } else if (isNonHypoxic) {
                return { category: 'Kh√¥ng thi·∫øu oxy', color: 'green' };
            } else {
                return { category: 'Kh√¥ng x√°c ƒë·ªãnh', color: 'gray' };
            }
        }

        function displayResults(nice, rcog, figo, acog, physio) {
            document.getElementById('niceResult').innerHTML = `
                <span class="status-${nice.color === 'green' ? 'normal' : nice.color === 'yellow' ? 'suspicious' : 'abnormal'}">
                    ${nice.category}
                </span>
                ${nice.category === 'B√¨nh th∆∞·ªùng' ? '<p>CTG b√¨nh th∆∞·ªùng. Ti·∫øp t·ª•c theo d√µi th∆∞·ªùng quy.</p>' :
                  nice.category === 'Nghi ng·ªù' ? '<p>C·∫ßn ƒë√°nh gi√° to√†n di·ªán, xem x√©t nguy√™n nh√¢n v√† h·ªìi s·ª©c n·∫øu c·∫ßn.</p>' :
                  '<p>CTG b·∫•t th∆∞·ªùng. C·∫ßn can thi·ªáp ngay, xem x√©t ch·∫•m d·ª©t thai k·ª≥ kh·∫©n c·∫•p.</p>'}
            `;
            
            document.getElementById('rcogResult').innerHTML = `
                <span class="status-${rcog.color === 'green' ? 'normal' : rcog.color === 'yellow' ? 'suspicious' : 'abnormal'}">
                    ${rcog.category}
                </span>
                ${rcog.category === 'B√¨nh th∆∞·ªùng' ? '<p>CTG an t√¢m. Ti·∫øp t·ª•c theo d√µi.</p>' :
                  rcog.category === 'Nghi ng·ªù' ? '<p>CTG kh√¥ng an t√¢m. C·∫ßn theo d√µi s√°t v√† ƒë√°nh gi√° th√™m.</p>' :
                  '<p>CTG b·∫•t th∆∞·ªùng. C·∫ßn can thi·ªáp kh·∫©n c·∫•p.</p>'}
            `;
            
            document.getElementById('figoResult').innerHTML = `
                <span class="status-${figo.color === 'green' ? 'normal' : figo.color === 'yellow' ? 'suspicious' : 'abnormal'}">
                    ${figo.category}
                </span>
                ${figo.category === 'B√¨nh th∆∞·ªùng' ? '<p>Kh√¥ng c·∫ßn can thi·ªáp.</p>' :
                  figo.category === 'Nghi ng·ªù' ? '<p>X√°c ƒë·ªãnh v√† kh·∫Øc ph·ª•c nguy√™n nh√¢n, theo d√µi s√°t.</p>' :
                  '<p>H√†nh ƒë·ªông ngay ƒë·ªÉ kh·∫Øc ph·ª•c t√¨nh tr·∫°ng thi·∫øu oxy.</p>'}
            `;
            
            document.getElementById('acogResult').innerHTML = `
                <span class="status-${acog.color === 'green' ? 'normal' : acog.color === 'yellow' ? 'suspicious' : 'abnormal'}">
                    ${acog.category}
                </span>
                ${acog.category === 'Nh√≥m I' ? '<p>CTG b√¨nh th∆∞·ªùng, ti√™n l∆∞·ª£ng t·ªët.</p>' :
                  acog.category === 'Nh√≥m II' ? '<p>CTG kh√¥ng x√°c ƒë·ªãnh, c·∫ßn theo d√µi v√† ƒë√°nh gi√° th√™m.</p>' :
                  '<p>CTG b·∫•t th∆∞·ªùng, nguy c∆° toan chuy·ªÉn h√≥a thai nhi.</p>'}
            `;
            
            document.getElementById('physioResult').innerHTML = `
                <span class="status-${physio.color === 'green' ? 'normal' : physio.color === 'yellow' ? 'suspicious' : physio.color === 'orange' ? 'suspicious' : 'abnormal'}">
                    ${physio.category}
                </span>
                ${physio.category === 'Kh√¥ng thi·∫øu oxy' ? '<p>Thai nhi kh√¥ng c√≥ d·∫•u hi·ªáu thi·∫øu oxy.</p>' :
                  physio.category === 'Thi·∫øu oxy di·ªÖn ti·∫øn c√≤n b√π' ? '<p>Thai nhi ƒëang b√π tr·ª´ t·ªët, c·∫ßn can thi·ªáp b·∫£o t·ªìn.</p>' :
                  physio.category === 'Thi·∫øu oxy di·ªÖn ti·∫øn m·∫•t b√π' ? '<p>C·∫ßn can thi·ªáp kh·∫©n c·∫•p ƒë·ªÉ ƒë·∫£o ng∆∞·ª£c t√¨nh tr·∫°ng thi·∫øu oxy.</p>' :
                  physio.category === 'Thi·∫øu oxy b√°n c·∫•p' ? '<p>Ng∆∞ng oxytocin/prostaglandin, ƒë√°nh gi√° m·ªï l·∫•y thai.</p>' :
                  physio.category === 'Thi·∫øu oxy c·∫•p' ? '<p>Lo·∫°i tr·ª´ tai bi·∫øn s·∫£n khoa, m·ªï l·∫•y thai kh·∫©n c·∫•p n·∫øu c·∫ßn.</p>' :
                  '<p>Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ph√¢n lo·∫°i.</p>'}
            `;
            
            // Generate recommendations
            let recommendations = [];
            
            if (nice.category === 'B·∫•t th∆∞·ªùng' || rcog.category === 'B·∫•t th∆∞·ªùng' || 
                figo.category === 'B·ªánh l√Ω' || acog.category === 'Nh√≥m III' || 
                physio.category.includes('c·∫•p')) {
                recommendations.push('‚ö†Ô∏è <strong>CAN THI·ªÜP KH·∫®N C·∫§P:</strong>');
                recommendations.push('‚Ä¢ ƒê√°nh gi√° l√¢m s√†ng to√†n di·ªán ngay l·∫≠p t·ª©c');
                recommendations.push('‚Ä¢ Lo·∫°i tr·ª´ c√°c tai bi·∫øn s·∫£n khoa c·∫•p (sa d√¢y r·ªën, nhau bong non, v·ª° t·ª≠ cung)');
                recommendations.push('‚Ä¢ Ng∆∞ng oxytocin/prostaglandin n·∫øu ƒëang s·ª≠ d·ª•ng');
                recommendations.push('‚Ä¢ Thay ƒë·ªïi t∆∞ th·∫ø s·∫£n ph·ª• sang n·∫±m nghi√™ng tr√°i');
                recommendations.push('‚Ä¢ B√π d·ªãch nhanh n·∫øu c√≥ t·ª•t huy·∫øt √°p');
                recommendations.push('‚Ä¢ C√¢n nh·∫Øc m·ªï l·∫•y thai kh·∫©n c·∫•p n·∫øu kh√¥ng c·∫£i thi·ªán trong 9-15 ph√∫t');
            } else if (nice.category === 'Nghi ng·ªù' || rcog.category === 'Nghi ng·ªù' || 
                       figo.category === 'Nghi ng·ªù' || acog.category === 'Nh√≥m II') {
                recommendations.push('‚ö° <strong>THEO D√ïI S√ÅT V√Ä CAN THI·ªÜP B·∫¢O T·ªíN:</strong>');
                recommendations.push('‚Ä¢ ƒê√°nh gi√° l·∫°i m·ªói 30-60 ph√∫t');
                recommendations.push('‚Ä¢ Kh√°m √¢m ƒë·∫°o ƒë√°nh gi√° ti·∫øn tri·ªÉn chuy·ªÉn d·∫°');
                recommendations.push('‚Ä¢ Thay ƒë·ªïi t∆∞ th·∫ø s·∫£n ph·ª•');
                recommendations.push('‚Ä¢ ƒê·∫£m b·∫£o hydrat h√≥a t·ªët');
                recommendations.push('‚Ä¢ Gi·∫£m li·ªÅu ho·∫∑c ng∆∞ng oxytocin n·∫øu c·∫ßn');
                recommendations.push('‚Ä¢ C√¢n nh·∫Øc k√≠ch th√≠ch da ƒë·∫ßu thai nhi');
                recommendations.push('‚Ä¢ S·∫µn s√†ng can thi·ªáp n·∫øu t√¨nh tr·∫°ng x·∫•u ƒëi');
            } else {
                recommendations.push('‚úÖ <strong>TI·∫æP T·ª§C THEO D√ïI TH∆Ø·ªúNG QUY:</strong>');
                recommendations.push('‚Ä¢ ƒê√°nh gi√° CTG m·ªói gi·ªù');
                recommendations.push('‚Ä¢ Theo d√µi ti·∫øn tri·ªÉn chuy·ªÉn d·∫°');
                recommendations.push('‚Ä¢ ƒê·∫£m b·∫£o s·∫£n ph·ª• tho·∫£i m√°i');
                recommendations.push('‚Ä¢ Ghi ch√©p ƒë·∫ßy ƒë·ªß h·ªì s∆°');
            }
            
            document.getElementById('recommendationResult').innerHTML = recommendations.join('<br>');
        }

        function exportPDF() {
            // In practice, you would use a library like jsPDF
            // For now, we'll use browser print
            window.print();
        }

        function saveToGoogleSheets() {
            const data = collectFormData();
            const results = {
                patientId: data.patientId || 'N/A',
                baselineHR: data.baselineHR,
                variability: data.variability,
                decelerations: data.decelerations,
                accelerations: data.accelerations,
                niceClassification: document.querySelector('#niceResult span').textContent,
                rcogClassification: document.querySelector('#rcogResult span').textContent,
                figoClassification: document.querySelector('#figoResult span').textContent,
                acogClassification: document.querySelector('#acogResult span').textContent,
                physioClassification: document.querySelector('#physioResult span').textContent,
                timestamp: new Date().toLocaleString('vi-VN')
            };
            
            // Google Apps Script URL (replace with your actual URL)
            const SCRIPT_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE';
            
            // Show loading
            document.querySelector('.loading').style.display = 'block';
            
            // Simulate save (in production, make actual fetch request to Google Apps Script)
            setTimeout(() => {
                alert('‚úÖ D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!\n\nL∆∞u √Ω: B·∫°n c·∫ßn c·∫•u h√¨nh Google Apps Script URL ƒë·ªÉ l∆∞u th·ª±c s·ª± v√†o Google Sheets.');
                document.querySelector('.loading').style.display = 'none';
                console.log('Data to save:', results);
            }, 1500);
            
            /* 
            // Actual implementation would be:
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(results)
            })
            .then(response => {
                alert('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!');
                document.querySelector('.loading').style.display = 'none';
            })
            .catch(error => {
                alert('L·ªói khi l∆∞u d·ªØ li·ªáu: ' + error);
                document.querySelector('.loading').style.display = 'none';
            });
            */
        }

        function resetForm() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu v√† b·∫Øt ƒë·∫ßu l·∫°i?')) {
                document.querySelectorAll('input[type="text"], select, textarea').forEach(element => {
                    element.value = '';
                });
                
                document.querySelectorAll('.conditional-question').forEach(element => {
                    element.style.display = 'none';
                });
                
                document.querySelectorAll('.uploaded-image').forEach(element => {
                    element.style.display = 'none';
                    element.src = '';
                });
                
                document.getElementById('resultsSection').style.display = 'none';
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Auto-generate description based on selections
        function generateDescription() {
            const data = collectFormData();
            let description = [];
            
            if (data.baselineHR) {
                description.push(`Tim thai cƒÉn b·∫£n: ${data.baselineHR} bpm`);
            }
            
            if (data.variability) {
                const variabilityText = {
                    '<3': 'kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c',
                    '3-5': 't·ªëi thi·ªÉu',
                    '6-25': 'trung b√¨nh',
                    '>25': 'tƒÉng',
                    'sinusoidal': 'd·∫°ng h√¨nh sin'
                };
                description.push(`Dao ƒë·ªông n·ªôi t·∫°i: ${variabilityText[data.variability] || data.variability}`);
            }
            
            if (data.decelerations) {
                const decelerationText = {
                    'none': 'kh√¥ng c√≥ nh·ªãp gi·∫£m',
                    'early': 'nh·ªãp gi·∫£m s·ªõm',
                    'variable': 'nh·ªãp gi·∫£m b·∫•t ƒë·ªãnh',
                    'late': 'nh·ªãp gi·∫£m mu·ªôn',
                    'prolonged': 'nh·ªãp gi·∫£m k√©o d√†i'
                };
                description.push(`Nh·ªãp gi·∫£m: ${decelerationText[data.decelerations]}`);
            }
            
            if (data.accelerations) {
                description.push(`Nh·ªãp tƒÉng: ${data.accelerations === 'present' ? 'c√≥' : 'kh√¥ng c√≥'}`);
            }
            
            document.getElementById('overallDescription').value = description.join('; ');
        }

        // Add event listeners to auto-generate description
        document.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', generateDescription);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter to analyze
            if (e.ctrlKey && e.key === 'Enter') {
                analyzeResults();
            }
            // Ctrl+S to save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveToGoogleSheets();
            }
            // Ctrl+P to export PDF
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                exportPDF();
            }
        });

        // Print styles
        const printStyles = document.createElement('style');
        printStyles.textContent = `
            @media print {
                body {
                    background: white;
                }
                .container {
                    box-shadow: none;
                }
                .action-buttons {
                    display: none;
                }
                .upload-btn, .camera-btn {
                    display: none;
                }
            }
        `;
        document.head.appendChild(printStyles);
    </script>
</body>
</html>